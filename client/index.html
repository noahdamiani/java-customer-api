<!DOCTYPE html>
<html>
    <head>
        <!-- Compiled and minified CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/css/materialize.min.css">

        <!-- Compiled and minified JavaScript -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0-rc.2/js/materialize.min.js"></script>
    </head>
    <body>

        <div class="container">
            <div class="row">
                <div class="col s4">
                    <h1>Customers</h1>
                    <div class="customers"></div>
                </div>
                <div class="col s4 edit-view">
                    <h1>Details:</h1>
                    <div class="detail-view"></div>
                        <div class="row">
                            <div class="input-field col s6">
                                <input placeholder="First Name" id="firstNameEdit" type="text" class="validate">
                                <label for="firstNameEdit">First Name</label>
                            </div>
                            <div class="input-field col s6">
                                <input placeholder="Last Name" id="lastNameEdit" type="text" class="validate">
                                <label for="lastNameEdit">Last Name</label>
                            </div>
                        </div>
                        <div class="row">
                            <div class="input-field col s6">
                                <input placeholder="Age" id="ageEdit" type="text" class="validate">
                                <label for="ageEdit">Age</label>
                            </div>
                            <div class="input-field col s6">
                                <input placeholder="Company" id="companyEdit" type="text" class="validate">
                                <label for="companyEdit">Company</label>
                            </div>
                        </div>
                        <div class="row">
                            <a class="waves-effect waves-light btn update-customer">Update</a>
                        </div>
                </div>
                <div class="col s4">
            <div class="row">
                <h1>Add Customer</h1>
                    <form class="col s12">
                        <div class="row">
                            <div class="input-field col s6">
                                <input placeholder="First Name" id="first_name" type="text" class="validate">
                                <label for="first_name">First Name</label>
                            </div>
                            <div class="input-field col s6">
                                <input placeholder="Last Name" id="last_name" type="text" class="validate">
                                <label for="last_name">Last Name</label>
                            </div>
                            </div>
                            <div class="row">
                                <div class="input-field col s6">
                                    <input placeholder="Age" id="age" type="text" class="validate">
                                    <label for="age">Age</label>
                                </div>
                                <div class="input-field col s6">
                                    <input placeholder="Company" id="company" type="text" class="validate">
                                    <label for="Company">Company</label>
                                </div>
                            </div>
                            <div class="row">
                                <a class="waves-effect waves-light btn add-customer">Add</a>
                            </div>
                        </div>
                    </form>
                    </div>
                </div>
            </div>

        
        </div>

        <script>
            let addButton = document.querySelector('.add-customer');
            let updatebutton = document.querySelector('.update-customer');

            class App {
                constructor() {
                    this.getCustomerList();
                   
                    updatebutton.addEventListener('click', this.updateCustomer);
                    addButton.addEventListener('click', this.addCustomer);
                }
                updateCustomer(e) {
                    let firstName = document.querySelector('#firstNameEdit').value;
                    let lastName = document.querySelector('#lastNameEdit').value;
                    let company = document.querySelector('#companyEdit').value;
                    let age = parseInt(document.querySelector('#ageEdit').value);

                    let id = e.target.modelData;

                    let payload = {
                        "firstName": firstName,
                        "lastName": lastName,
                        "company": company,
                        "age": age
                    }

                    let xhr = new XMLHttpRequest();
                    xhr.open("PUT", `http://localhost:4567/customers/update/${id}`, true);

                    //Send the proper header information along with the request
                    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

                    xhr.onreadystatechange = function() {//Call a function when the state changes.
                        if(this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                            // Request finished. Do processing here.
                            window['App'].getCustomerList();
                        }
                    }
                    xhr.send(JSON.stringify(payload)); 
                }
                addCustomer(e) {
                    let firstName = document.querySelector('#first_name').value;
                    let lastName = document.querySelector('#last_name').value;
                    let company = document.querySelector('#company').value;
                    let age = parseInt(document.querySelector('#age').value);

                    let payload = {
                        "firstName": firstName,
                        "lastName": lastName,
                        "company": company,
                        "age": age
                    }

                    let xhr = new XMLHttpRequest();
                    xhr.open("POST", 'http://localhost:4567/customers/add', true);

                    //Send the proper header information along with the request
                    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");

                    xhr.onreadystatechange = function() {//Call a function when the state changes.
                        if(this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                            // Request finished. Do processing here.
                            window['App'].getCustomerList();
                        }
                    }
                    xhr.send(JSON.stringify(payload)); 
                }
                getCustomer(id) {
                    fetch(`http://localhost:4567/customers/${id}`, { headers: { "Content-Type": "application/json; charset=utf-8" }})
                    .then(res => res.json()) // parse response as JSON (can be res.text() for plain response)
                    .then(response => {
                        let customer = response;
                        let details = response.data;
                        let detailView = document.querySelector('.detail-view');
                        let content = document.createElement('div');
                        let dets = [details.firstName, details.lastName, details.age, details.company];
                        let inputs = document.querySelectorAll('.edit-view input');
                        for(let i = 0; i < dets.length; i++) {
                            inputs[i].value = dets[i];
                        }
                        content.innerHTML = `Name: ${details.firstName} ${details.lastName} Age: ${details.age} Company: ${details.company}`
                        detailView.innerHTML = '';
                        detailView.modelData = id;
                        updatebutton.modelData = id;
                        detailView.appendChild(content);
                    })
                    .catch(err => {
                        console.log("Error fetching customer", err);
                    });
                }
                getCustomerList() {
                    fetch("http://localhost:4567/customers", { headers: { "Content-Type": "application/json; charset=utf-8" }})
                    .then(res => res.json()) // parse response as JSON (can be res.text() for plain response)
                    .then(response => {
                        let customers = response;
                        let customerList = document.querySelector('.customers');

                        customerList.innerHTML = '';
                        
                        for(let i = 0; i < customers.length; i++) {
                            let details = customers[i].data;
                            let customerListItem = document.createElement('div');
                            customerListItem.modelData = response[i];
                            customerListItem.addEventListener('click', (e) => this.getCustomer(e.target.modelData.id));
                            let liStr = `Name: ${details.firstName} ${details.lastName}`;
                            customerListItem.innerHTML = liStr;
                            customerList.appendChild(customerListItem);
                        }
                    })
                    .catch(err => {
                        console.log("Error fetching customer list", err);
                    });
                }
                
            }
            
            window['App'] = new App();
        </script>
    </body>
</html>